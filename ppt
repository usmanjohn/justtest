import pandas as pd

# Convert contract dates
df['date_contract'] = pd.to_datetime(df['date_contract'])

# Extract all monthly columns and convert them to datetimes
date_cols = [c for c in df.columns if c.startswith("date_")]
date_map = {
    col: pd.to_datetime(col.replace("date_", ""), format="%d.%m.%Y")
    for col in date_cols
}

# Sort by actual date
sorted_date_cols = sorted(date_cols, key=lambda c: date_map[c])

# Function to compute dpd columns for a single row
def calculate_dpd(row):
    contract_date = row['date_contract']
    
    # first month after contract date
    start_month = (contract_date + pd.offsets.MonthBegin(1)).to_period('M')
    
    dpd_values = {}
    dpd_index = 0
    
    for col in sorted_date_cols:
        col_month = date_map[col].to_period('M')
        
        if col_month >= start_month:
            dpd_values[f"dpd_{dpd_index}"] = row[col]
            dpd_index += 1
            
    return pd.Series(dpd_values)

# Apply to each row
dpd_df = df.apply(calculate_dpd, axis=1)

# Merge with original
df_final = pd.concat([df[['dealid', 'date_contract']], dpd_df], axis=1)

df_final
