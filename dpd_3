import pandas as pd
import numpy as np
from datetime import datetime

def calculate_monthly_dpd_fast(df):
    """
    OPTIMIZED: Calculate DPD for each dealid for every month from 2020-01-01 to 2025-11-01
    Uses vectorized operations for speed - NO LOOPS!
    
    Logic: 
    - For reporting month M, calculate cumulative DPD that occurred BEFORE month M
    - DPD accumulates from valuedate until tilldate
    - After tilldate, DPD resets to 0
    
    Parameters:
    -----------
    df: DataFrame with columns ['dealid', 'valuedate', 'tilldate']
    
    Returns:
    --------
    DataFrame with columns ['dealid', 'reporting_date', 'dpd']
    """
    
    print("Starting DPD calculation...")
    
    # Convert date columns to datetime
    df = df.copy()
    df['valuedate'] = pd.to_datetime(df['valuedate'])
    df['tilldate'] = pd.to_datetime(df['tilldate'])
    
    # Generate monthly reporting dates (first day of each month)
    date_range = pd.date_range(start='2020-01-01', end='2025-11-01', freq='MS')
    
    print(f"Processing {len(df)} deals across {len(date_range)} months...")
    
    # Get unique dealids
    unique_deals = df['dealid'].unique()
    
    # Create a cross join: all dealids × all reporting dates
    # This is MUCH faster than looping
    deals_df = pd.DataFrame({'dealid': unique_deals})
    dates_df = pd.DataFrame({'reporting_date': date_range})
    
    # Cross join (Cartesian product)
    deals_df['key'] = 1
    dates_df['key'] = 1
    result = deals_df.merge(dates_df, on='key').drop('key', axis=1)
    
    print(f"Created {len(result):,} rows (dealid × month combinations)")
    
    # Merge with original data to get valuedate and tilldate for each deal
    result = result.merge(df[['dealid', 'valuedate', 'tilldate']], on='dealid', how='left')
    
    # Calculate previous month end date (last day before reporting month)
    result['prev_month_end'] = result['reporting_date'] - pd.Timedelta(days=1)
    
    # Vectorized DPD calculation
    # Condition 1: Past due hasn't started yet
    condition_not_started = result['prev_month_end'] < result['valuedate']
    
    # Condition 2: Past due ended before the reporting month
    condition_ended = (result['tilldate'] < result['reporting_date']) & \
                      (result['tilldate'].dt.to_period('M') < result['reporting_date'].dt.to_period('M'))
    
    # Condition 3: Past due ended in the previous month (show total DPD)
    condition_ended_prev_month = (result['prev_month_end'] >= result['tilldate']) & \
                                  (result['tilldate'].dt.to_period('M') == result['prev_month_end'].dt.to_period('M'))
    
    # Condition 4: Past due is ongoing (accumulating)
    condition_ongoing = (result['prev_month_end'] >= result['valuedate']) & \
                        (result['prev_month_end'] < result['tilldate'])
    
    # Calculate DPD based on conditions
    result['dpd'] = 0  # Default
    
    # For ended in previous month: total days from valuedate to tilldate
    result.loc[condition_ended_prev_month, 'dpd'] = \
        (result.loc[condition_ended_prev_month, 'tilldate'] - 
         result.loc[condition_ended_prev_month, 'valuedate']).dt.days
    
    # For ongoing: cumulative days from valuedate to end of previous month
    result.loc[condition_ongoing, 'dpd'] = \
        (result.loc[condition_ongoing, 'prev_month_end'] - 
         result.loc[condition_ongoing, 'valuedate']).dt.days + 1
    
    # Add status
    result['status'] = 'current'
    result.loc[condition_ongoing, 'status'] = 'past_due'
    result.loc[condition_ended_prev_month, 'status'] = 'resolved'
    
    # Clean up intermediate columns
    result = result[['dealid', 'reporting_date', 'dpd', 'status']]
    
    print("✓ Calculation complete!")
    
    return result


def calculate_monthly_dpd_aggregated(df):
    """
    ULTRA-FAST version: If a dealid can have multiple past due periods,
    this aggregates them by taking the maximum DPD per dealid per month
    """
    
    print("Starting aggregated DPD calculation...")
    
    # First, calculate DPD for all records
    result = calculate_monthly_dpd_fast(df)
    
    # If there are multiple records per dealid per month, aggregate
    if result.duplicated(subset=['dealid', 'reporting_date']).any():
        print("Aggregating multiple periods per dealid...")
        result = result.groupby(['dealid', 'reporting_date']).agg({
            'dpd': 'max',  # Take maximum DPD
            'status': lambda x: 'past_due' if 'past_due' in x.values else x.iloc[0]
        }).reset_index()
    
    return result


def add_dpd_buckets(result_df):
    """
    Add standard DPD buckets - VECTORIZED
    """
    result_df = result_df.copy()
    
    result_df['dpd_bucket'] = pd.cut(
        result_df['dpd'],
        bins=[-1, 0, 30, 60, 90, 180, np.inf],
        labels=['Current', '1-30 DPD', '31-60 DPD', '61-90 DPD', 
                '91-180 DPD', '180+ DPD (NPL)']
    )
    
    return result_df


def get_summary_statistics(result_df):
    """
    Generate summary statistics for DPD analysis
    """
    summary = {
        'total_deals': result_df['dealid'].nunique(),
        'total_observations': len(result_df),
        'avg_dpd_overall': result_df['dpd'].mean(),
        'avg_dpd_when_past_due': result_df[result_df['dpd'] > 0]['dpd'].mean(),
        'max_dpd': result_df['dpd'].max(),
        'deals_ever_past_due': result_df[result_df['dpd'] > 0]['dealid'].nunique(),
        'pct_months_with_past_due': (result_df['dpd'] > 0).sum() / len(result_df) * 100
    }
    
    return pd.Series(summary)


# Example usage:
"""
# Load your data
import time

df = pd.read_excel('your_data.xlsx')  # or pd.read_csv('your_data.csv')

# Time the execution
start_time = time.time()

# Calculate DPD (FAST!)
result = calculate_monthly_dpd_fast(df)

# Or if you have multiple periods per dealid:
# result = calculate_monthly_dpd_aggregated(df)

# Add risk buckets
result = add_dpd_buckets(result)

elapsed = time.time() - start_time
print(f"\n⏱️  Processing completed in {elapsed:.2f} seconds")

# View results
print("\nSample results:")
print(result.head(20))

# Summary
print("\n=== PORTFOLIO SUMMARY ===")
print(get_summary_statistics(result))

# Save to file
result.to_csv('monthly_dpd_output.csv', index=False)
# or
result.to_excel('monthly_dpd_output.xlsx', index=False)

print("\n✓ Results saved!")

# Test with examples
test_df = pd.DataFrame({
    'dealid': ['CLIENT001', 'CLIENT002'],
    'valuedate': ['2023-04-03', '2023-04-03'],
    'tilldate': ['2023-06-18', '2023-04-18']
})

test_result = calculate_monthly_dpd_fast(test_df)
print("\n=== TEST EXAMPLES ===")
print(test_result[(test_result['reporting_date'] >= '2023-04-01') & 
                  (test_result['reporting_date'] <= '2023-07-01')])
"""
