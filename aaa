import pandas as pd
import glob
import openpyxl

def process_and_merge_excels():
    excel_files = glob.glob("*.xlsx") + glob.glob("*.xls")
    if not excel_files:
        print("No Excel files found.")
        return
    
    all_dfs = []

    for file_path in excel_files:
        print(f"Processing file: {file_path}")

        # Get sheet names safely
        try:
            wb = openpyxl.load_workbook(file_path, read_only=True, data_only=True)
            sheet_names = wb.sheetnames
        except Exception as e:
            print(f"Cannot open {file_path}: {e}")
            continue

        for sheet_name in sheet_names:
            print(f"  -> Reading sheet '{sheet_name}'")

            try:
                # ❗ Read only A1:B85 — this is the KEY FIX
                df = pd.read_excel(
                    file_path,
                    sheet_name=sheet_name,
                    usecols="A:B",
                    header=None,
                    engine="openpyxl",
                    nrows=85     # <--- LIMIT ROWS
                )
            except Exception as e:
                print(f"     !! Sheet read error: {e}")
                continue

            # Remove rows that are completely empty (optional)
            # df = df.dropna(how="all")

            if df.empty:
                print(f"     -> Empty sheet, skipping.")
                continue

            # Extract company name from merged cells row 1
            company_name = df.iloc[0].dropna().iloc[0]

            # Actual data begins from row 2 to row 85
            df = df.iloc[1:].copy()

            df.rename(columns={df.columns[0]: "Category"}, inplace=True)
            df.rename(columns={df.columns[1]: company_name}, inplace=True)

            all_dfs.append(df)

    if not all_dfs:
        print("No data collected.")
        return

    print("Merging all DataFrames...")

    merged = all_dfs[0]
    for df in all_dfs[1:]:
        merged = merged.merge(df, on="Category", how="outer")

    print("Done. Shape:", merged.shape)
    print(merged.head())

    return merged
