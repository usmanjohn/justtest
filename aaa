import pandas as pd
import glob
import os

def process_and_merge_excels():
    # Find all Excel files in the current directory
    excel_files = glob.glob('*.xlsx') + glob.glob('*.xls')
    
    if not excel_files:
        print("No Excel files found in the current directory.")
        return

    all_dataframes = []
    
    # Iterate through each file found
    for file_path in excel_files:
        print(f"--- Processing file: {file_path} ---")
        
        try:
            # Load all sheets in the file. We use openpyxl engine for .xlsx files.
            # Using sheet_name=None reads all sheets into a dictionary of DataFrames.
            xls = pd.ExcelFile(file_path, engine='openpyxl')
            sheet_names = xls.sheet_names
            
            for sheet_name in sheet_names:
                print(f"  - Reading sheet: '{sheet_name}'")

                # Read the specific sheet. We target only the first two columns (A and B).
                # header=None so we can process the merged company name manually later.
                # usecols='A:B' limits reading to only those columns.
                df = pd.read_excel(
                    xls,
                    sheet_name=sheet_name,
                    usecols='A:B',
                    header=None,
                    # data_only=True ensures we read values, not formulas (default behavior in pandas)
                    #data_only=True
                )
                
                # --- Data Cleaning and Structuring ---

                # Remove any fully empty rows that might appear
                df = df.dropna(how='all')

                # Skip empty sheets (if no data remains after dropping empty rows)
                if df.empty:
                    print(f"    -> Sheet '{sheet_name}' is empty or has no data in first two columns. Skipping.")
                    continue

                # 1. Extract the Company Name (which is in the very first cell [0, 0] or [0, 1] due to merging)
                # We prioritize the first non-NaN value in the first row.
                company_name = df.iloc[0].dropna().iloc[0]
                
                # 2. Assign the company name to the second column for all relevant rows
                # We drop the first row now as it was just the header row we extracted data from
                df = df.iloc[1:].copy() 
                
                # The first column will be the 'Categories' column name across all sheets
                df.rename(columns={df.columns[0]: 'Category'}, inplace=True)
                
                # The second column gets the specific company name derived from the header
                df.rename(columns={df.columns[1]: company_name}, inplace=True)
                
                # Ensure 'Category' column is first
                df = df[['Category', company_name]]

                # Add the cleaned dataframe to our list
                all_dataframes.append(df)
                print(f"    -> Successfully processed '{company_name}' data.")

        except Exception as e:
            print(f"An error occurred while processing file {file_path}: {e}")

    # --- Merging All DataFrames ---

    if not all_dataframes:
        print("No data was successfully processed from any file/sheet.")
        return
        
    print("\n--- Merging all processed dataframes ---")
    
    # Merge all dataframes on the 'Category' column (left join style to keep all categories)
    # The first dataframe initializes the merge, subsequent ones merge iteratively.
    merged_df = all_dataframes[0]
    for i in range(1, len(all_dataframes)):
        # outer join ensures we capture all unique categories present across all sheets
        merged_df = pd.merge(merged_df, all_dataframes[i], on='Category', how='outer')
        
    # Optional: Fill potential NaNs in the final data body with a placeholder like 0 or an empty string
    # merged_df = merged_df.fillna(0) 

    # Save the final result to a new Excel file
    #output_filename = 'Merged_Company_Data.xlsx'
    #merged_df.to_excel(output_filename, index=False)
    
    print(f"\n--- DONE ---")
    print("Final Merged Data Shape:", merged_df.shape)
    print("\nFirst few rows of merged data:\n", merged_df.head())
    return merged_df

# Run the function


